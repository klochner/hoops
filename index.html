<!DOCTYPE html>
<html>
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-108916837-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-108916837-1');
	</script>

	<title>Watch Hoops | Less clicking. More balling. | Ball so hard mothafuckas wanna fine me.</title>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<link rel="stylesheet" href="main.css">
	<!-- Favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
	<link rel="manifest" href="manifest.json">
	<link rel="mask-icon" href="safari-pinned-tab.svg" color="#000000">
	<meta name="theme-color" content="#ffffff">
</head>
<body>
	<header>
		<h1>Watch Hoops</h1>
	</header>
	<main>
		<div id='gameFeed'></div>
	</main>
	<footer>
		<div>All times display in <span id='timezone'></span>.
	</footer>
	<div id='madeBy'>Made with <img src='https://cdn.worldvectorlogo.com/logos/dribbble-icon-1.svg' alt='love'> by Tyler Infelise.</div>

	<!-- Libraries -->
	<script src="https://use.fontawesome.com/1727fd84aa.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery.countdown/2.2.0/jquery.countdown.min.js'></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<!-- <script src="https://momentjs.com/downloads/moment-timezone.min.js"></script> -->
	<script src="https://momentjs.com/downloads/moment-timezone-with-data-2012-2022.min.js"></script>

	<!-- Javascript -->
	<script src="nba.js"></script>
	<script>

		var now = new Date();
			now = now.getTime();
		var today = moment(now).format('YYYYMMDD');
		var month = moment(now).format('MMMM');

		var games = [
			// {
			// 	"league":"NBA",
			// 	"home_team":"Warriors",
			// 	"away_team":"Rockets",
			// 	"start":"Oct 22 2017 16:00:00 PDT",
			// 	"network":""
			// },
			// {
			// 	"league":"NBA",
			// 	"home_team":"Thunder",
			// 	"away_team":"Pelicans",
			// 	"start":"Oct 22 2017 17:30:00 PDT",
			// 	"network":"TNT"	
			// }
		];

		// var todays_NBA_games = [];
		function filterNBAData () {
			nba = nba.lscd;
			var x = 0;
			var nba_games = [];
			
			for (i in nba) {
				var month_games = nba[i].mscd;
				for (each in month_games.g) {
					nba_games[x] = month_games.g[each];
					x++;
				};
			};

			for (i in nba_games) {
				var game_day = nba_games[i].etm;
					game_day = moment(game_day).format('YYYYMMDD');
				if (game_day == today) {
					var home = nba_games[i].h.tn;
					var away = nba_games[i].v.tn;
					var start = nba_games[i].etm;
						start = start + '-04:00'; // EST timezone offset
					var network = '';
					var networks = nba_games[i].bd.b;
					for (i in networks) {
						if ( (networks[i].scope == 'natl') && (networks[i].type == 'tv') && (networks[i].disp != 'NBATV') ) {
							network = networks[i].disp;
						};
					};
					// todays_NBA_games.push(home);
					createGame('NBA', home, away, start, network);
				}
			};
		};
		filterNBAData();

		// var nba_schedule_url = "https://api.mysportsfeeds.com/v1.1/pull/nba/2017-2018-current/daily_game_schedule.json?fordate=" + today;
			// nba_schedule_url = "https://api.mysportsfeeds.com/v1.1/pull/nba/current/daily_game_schedule.json?fordate=" + today; // trying not to specify the season
				// https://www.mysportsfeeds.com/data-feeds/api-docs/#
				// date format: 20171022
		// console.log(nba_schedule_url);

		// $.ajax({
		// 	type: "GET",
		// 	url: nba_schedule_url,
		// 	dataType: 'json',
		// 	async: false,
		// 	headers: {
		// 		"Authorization": "Basic " + btoa('tinfelise' + ":" + 'ewFEwbYMKMeDacwPgN4q')
		//   	},
		//   	data: '{ "comment" }',
		//   	success: function (){
		//     	alert('Thanks for your comment!'); 
		//   	}
		// });

		// var nba_schedule_url = 'https://data.nba.com/data/10s/v2015/json/mobile_teams/nba/2017/league/00_full_schedule_week.json';
		// var nba = [];
		// $.ajax({
		// 	type: "GET",
		// 	url: nba_schedule_url,
		// 	dataType: 'jsonp',
		// 	// async: false,
		//   	// data: '{ "comment" }',
		//   	// jsonp: false,
		//   	// jsonpCallback: "myJsonMethod",
		//   	success: function (data){
		  		
		//     	// console.log(data);
		//     	nba = data.lscd;
		//     	var x = 0;
		//     	var nba_games = [];
		//     	for (i in nba) {
		//     		var month_games = nba[i].mscd;
		//     		// console.log(month_games.g.length);
		//     		for (each in month_games.g) {
		//     			nba_games[x] = month_games.g[each];
		//     			x++;
		//     		};
		//     	};

		// function callback(json) {
		// 	console.log(json.Message);
		// };
		// $.ajax({
		// 	type: "GET",
		// 	url: "https://data.nba.com/data/10s/v2015/json/mobile_teams/nba/2017/league/00_full_schedule_week.json?format=jsonp",
		// 	dataType: 'jsonp',
		// 	jsonpCallback: 'callback',
		// 	jsonp:false
		//   	success: function (data){
		//     	console.log(data);
		//   	}
		// });

		var league_logos = {
			"NBA":"https://upload.wikimedia.org/wikipedia/en/0/03/National_Basketball_Association_logo.svg",
			"NCAA":"https://upload.wikimedia.org/wikipedia/commons/d/dd/NCAA_logo.svg",
			"NESCAC":"http://cdnak1.psbin.com/dk4a6ui7bcqy4017/images/setup/2014/footer_logo_nescac.png"
		};

		var networks = {
			"ESPN": {
				"logo":"http://stats.nba.com/media/img/broadcast-logos/espn.svg",
				"link":"http://www.espn.com/watch/",
				"app": {
					"link":"sportscenter://x-callback-url/showFeatured",
					"icon":"http://a.espncdn.com/wireless/mw5/r1/images/bookmark-icons/espn_icon-57x57.min.png"
				}
			},
			"TNT": {
				"logo":"http://stats.nba.com/media/img/broadcast-logos/tnt.svg",
				"link":"http://www.tntdrama.com/watchtnt",
				"app": {
					"link":"watchtnt://",
					"icon":"http://is5.mzstatic.com/image/thumb/Purple118/v4/b9/8b/e3/b98be35a-45db-34f9-f5e5-57476424c7c0/source/175x175bb.jpg"
				}
			},
			"NBATV": {
				"logo":"http://stats.nba.com/media/img/broadcast-logos/nbatv.svg",
				"app": {
					"link":"nba://",
					"icon":"http://cdn.nba.net/assets/icons/apple-touch-icon.png"
				}
			}
		};

		function createGame(league, home, away, start, network) {
			var game = {};
			game.league = league;
			game.home_team = home;
			game.away_team = away;
			game.start = start;
			if (network) {
				game.network = network;
			};
			games.push(game);
		};

		function orderGames () {
			games = games.sort(function (a, b) {
		    	return moment(a.start).format('x')
		    		.localeCompare(
		    			moment(b.start).format('x')
					);
			});
		};

		function createCountdown (elem, timestamp) {
			$(elem).prepend('<h2 class="countdown"></h2>');
			$(elem).countdown(timestamp)
				.on('update.countdown', function(event) {
					var timer = '';
					if(event.offset.hours > 5) {
						timer = '<div>Later today</div>';
						$(this).addClass('later');
					} else if(event.offset.hours > 0) {
						timer = '<div>In %-H hour%!H %-M minute%!M</div>';
					} else if(event.offset.minutes > 15) {
						timer = '<div>In %-M minute%!M</div>';
					} else {
						timer = '<div>Starting soon</div>';
						$(this).addClass('gametime');
					};
					$('.countdown', this).html(event.strftime(timer));
				})
				.on('finish.countdown', function(event) {
					$('.countdown', this).html('<div>On now</div>');
					$(this).addClass('gametime now');
				});
		};
		function createCountdowns (selector) {
			$(selector).each( function() {
				var id = '#' + $(this).attr('id');
				var timestamp = $(this).attr('data-timestamp');
				createCountdown(id, timestamp);
			});
		};

		function reddit (league, home, away) {
			var link = "";
			if (league == "NBA") {
				link = "https://www.reddit.com/r/nbastreams/search?q=";
				link += home + "+" + away;
				link += "&restrict_sr=on";
			};
			return link;
		};

		function createDailyFeed () {
			var games_html = '';
			if (games.length == 0) {
				games_html = '<h2 id="noGames">There are no games today. <span>Stay strong.</span></h2>';
				$('footer div').hide();
			};
			for (i in games) {
				var league_logo = league_logos[games[i].league];
				var destination = '';
				var cta = '';
				var network_logo = '';
				var national = false;

				if (games[i].network) {
					national = true;
					var network = games[i].network;
					destination = "Watch on " + network;
					cta = networks[network].link;
					network_logo = networks[network].logo;
				} else {
					destination = "Search on Reddit";
					cta = reddit(games[i].league,games[i].home_team,games[i].away_team);
					network_logo = 'http://svgshare.com/i/2SL.svg';
				}
				
				var home_logo = nba_teams[games[i].home_team].logo;
				var away_logo = nba_teams[games[i].away_team].logo;
				var time = moment(games[i].start).format('h:mma');
				var display_time = time;
				var unix_time = moment(games[i].start).format('x');
				var same_time_as_last = false;
				if ( (i > 0) && ( time == moment(games[i-1].start).format('h:mma') ) ) {
					same_time_as_last = true;
				};
				if (national) {
					display_time += " on <img src='" + network_logo + "' alt='" + network +"'>";
				};
				
				var html = ''
					+ "<a class='game' href='" + cta + "' target='blank_'>"
						+ "<div class='logos'>"
							+ "<img class='away' src='" + away_logo + "' alt='" + games[i].away_team + " Logo'>"
							+ "<img class='home' src='" + home_logo + "' alt='" + games[i].home_team + " Logo'>"
						+ "</div>"
						+ "<div class='data'>"
							+ "<h3>" + games[i].away_team + " @ " + games[i].home_team + "</h3>"
							// + "<div>"
								+ "<span class='time'>" + display_time + "</span>"
								+ "<span class='action'>" //href='" + cta + "' target='blank_'
									+ "<img src='" + network_logo + "' >"
									+ destination 
								+ "</span>"
							// + "</div>"
						+ "</div>"
						+ "<img class='leagueIcon' src='" + league_logo + "' alt='" + games[i].league + " logo'>"
					+ "</a>";

				var block_id = moment(games[i].start).format('hmmA') + '_start';
				if (i==0) {
					html = "<div class='block' id='" + block_id + "' data-timestamp='" + unix_time + "'>" + html;
				} else if ( (i > 0) && (same_time_as_last == false) ) {
					html = "</div>" + "<div class='block' id='" + block_id + "' data-timestamp='" + unix_time + "'>" + html;
				};
				if (i==games.length - 1) {
					html += '</div>'
				};
				games_html += html;
			};

			$('#gameFeed').append(games_html);
			createCountdowns('.block');
			guess_timezone();
		};

		function guess_timezone() {
			var est_timezone = moment.tz.guess();
			var est_timezone_abr = moment.tz(est_timezone).zoneName();
			if (games.length > 0) {
				$('#timezone').append(est_timezone_abr);
			};
		};

		// Tests
		function testURLs() {
			var currentURL = window.location.href;
				currentURL = currentURL.split('?')[1];
			if (currentURL) {
				currentURL = currentURL.split('&');
			};
			var parameters = {};
			for (i in currentURL) {
				var key = currentURL[i].split('=')[0];
				var val = currentURL[i].split('=')[1];
				parameters[key] = val;
			};
			console.log(parameters);
			var test = parameters.test;
			if (test) {
				window[test]();
			};
			createDailyFeed();
		};
		testURLs();

		function noGames () {
			games = [];
		}

	</script>

</body>
</html>